resources:
- name: github-repo
  type: git
  source:
    uri: https://github.com/ONSdigital/census-worth-self-help.git
    branch: master

- name: timer
  type: time
  source:
    interval: 1m

jobs:
- name: deploy
  plan:
  - get: timer
  - get: github-repo
    trigger: true
    
  - task: deploy
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: google/cloud-sdk
          tag: alpine

      params:
        AUTH_KEY : ((gcp.service-account-key))
        PROJECT : ((gcp.project-name))
        GCP_SECRETS_VERSION : ((gcp.secrets-version))

      caches:
      - path: github-repo/site/node_modules

      inputs:
      - name: github-repo

      run:
        path: sh
        args:
        - -exec
        - |
            echo "GCP Secrets Version : $GCP_SECRETS_VERSION"
            apk add --update nodejs nodejs-npm
            cd github-repo/site
            npm install
            BUILD="_build/content/"
            mkdir -p "$BUILD" && cp -R ../content/ "$BUILD"
            npm run build
            echo $AUTH_KEY > encrypted_key.txt
            base64 -d encrypted_key.txt > service-account.json
            gcloud auth activate-service-account --key-file service-account.json
            gcloud config set project $PROJECT
            gcloud app deploy -q