resources:
- name: census-worth-self-help
  type: git
  source:
    uri: https://github.com/ONSdigital/census-worth-self-help.git
    branch: master

- name: census-worth-self-help-test
  type: git
  source:
    uri: git@github.com:ONSdigital/census-worth-self-help-test.git
    branch: master
    private_key: ((git-test.private-key))

jobs:
- name: deploy
  plan:
  - get: census-worth-self-help
    trigger: true
  - get: census-worth-self-help-test
    trigger: true
  - task: deploy
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: google/cloud-sdk
          tag: alpine

      params:
        AUTH_KEY : ((gcp.service-account-key))
        PROJECT : ((gcp.project-name))
        GCP_SECRETS_VERSION : ((gcp.secrets-version))
        GIT_SECRETS_VERSION : ((git.secrets-version))
        GIT_TEST_SECRETS_VERSION : ((git-test.secrets-version))


      caches:
      - path: census-worth-self-help/site/node_modules

      inputs:
      - name: census-worth-self-help
      - name: census-worth-self-help-test

      run:
        path: sh
        args:
        - -exec
        - |
            echo "GCP Secrets Version      : $GCP_SECRETS_VERSION"
            echo "Git secrets Version      : $GIT_SECRETS_VERSION"
            echo "Git Test secrets Version : $GIT_TEST_SECRETS_VERSION"
            apk add --no-progress --update nodejs nodejs-npm
            cd census-worth-self-help/site
            npm ci
            BUILD="_build/content/"
            mkdir -p "$BUILD"
            cp -R ../../census-worth-self-help-test/content/ "$BUILD"
            npm run build
            set +x
            echo $AUTH_KEY > encrypted_key.txt
            set -x
            base64 -d encrypted_key.txt > service-account.json
            gcloud auth activate-service-account --key-file service-account.json
            gcloud config set project $PROJECT
            gcloud app deploy -q